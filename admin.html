<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DabbeWale ‚Ä¢ Admin Panel</title>
  <link rel="stylesheet" href="frontend/css/style.css">
  <style>
    body { margin:0; background:#f5f7fa; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .app-bar { display:flex; justify-content:space-between; align-items:center; padding:14px 18px; background:#1b5e20; color:#fff; position:sticky; top:0; z-index:10; }
    .container { max-width: 1100px; margin: 20px auto; padding: 0 16px; }
    .tabs { display:flex; gap:6px; flex-wrap:wrap; margin-bottom: 12px; }
    .tab { padding:10px 14px; border-radius:10px; border:1px solid #e0e0e0; background:#fff; cursor:pointer; font-weight:700; }
    .tab.active { background:#2e7d32; color:#fff; border-color:#2e7d32; }
    .panel { background:#fff; border:1px solid #e0e0e0; border-radius:14px; padding: 14px; }
    .toolbar { display:flex; gap:8px; align-items:center; margin-bottom: 10px; }
    .toolbar input, .toolbar select { padding:10px 12px; border:1px solid #e0e0e0; border-radius:10px; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid #eee; }
    th { color:#333; }
    .badge { padding:4px 10px; border-radius:100px; font-size:12px; font-weight:700; background:#eee; }
    .actions { display:flex; gap:8px; }
    .btn { border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn.ghost { border:1px solid #e0e0e0; background:#fff; }
    .btn.danger { background:#e53935; color:#fff; }
    #notification { position:fixed; top:70px; right:16px; display:none; color:#fff; padding:12px 16px; border-radius:10px; }
  </style>
</head>
<body>
  <div class="app-bar">
    <div>üõ†Ô∏è Admin Panel</div>
    <div>
      <button id="logoutBtn" class="btn danger">Logout</button>
    </div>
  </div>
  <div id="notification"></div>
  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="users">Users</button>
      <button class="tab" data-tab="providers">Providers</button>
      <button class="tab" data-tab="agents">Delivery Agents</button>
      <button class="tab" data-tab="orders">Orders</button>
    </div>
    <div class="panel">
      <div class="toolbar">
        <input id="search" type="search" placeholder="Search...">
        <select id="statusFilter" style="display:none;">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="preparing">Preparing</option>
          <option value="out_for_delivery">Out for Delivery</option>
          <option value="delivered">Delivered</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <button id="refreshBtn" class="btn ghost">Refresh</button>
      </div>
      <div class="table-wrap">
        <table id="dataTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    // Ensure API base is set once; default to localhost backend
    if (!localStorage.getItem('API_BASE_URL')) {
      localStorage.setItem('API_BASE_URL', 'http://localhost:5000');
    }
    const API_BASE_URL = localStorage.getItem('API_BASE_URL');
    const tabs = document.querySelectorAll('.tab');
    const thead = document.querySelector('#dataTable thead');
    const tbody = document.querySelector('#dataTable tbody');
    const search = document.getElementById('search');
    const statusFilter = document.getElementById('statusFilter');

    function token(){ return localStorage.getItem('token'); }
    function role(){ try { return JSON.parse(atob(token().split('.')[1])).role; } catch { return null; } }
    function ensureAdmin(){
      if (!token()) { alert('Login required'); window.location.href = 'login.html'; return false; }
      if (role() !== 'admin') { alert('Admin access required'); window.location.href = 'index.html'; return false; }
      return true;
    }
    function showToast(msg, ok=true){ const n=document.getElementById('notification'); n.textContent=msg; n.style.display='block'; n.style.background = ok?'#2e7d32':'#e53935'; setTimeout(()=>{n.style.display='none';},3000); }

    let currentTab = 'users';
    async function fetchData(){
      try {
        const params = new URLSearchParams();
        if (search.value.trim()) params.set('q', search.value.trim());
        if (currentTab === 'orders' && statusFilter.value) params.set('status', statusFilter.value);
        const res = await fetch(`${API_BASE_URL}/api/admin/${currentTab}?${params.toString()}`, { headers: { 'Authorization': `Bearer ${token()}` }});
        if (!res.ok) throw new Error(`Failed to load ${currentTab}`);
        const json = await res.json();
        renderTable(json.items || []);
      } catch (e) {
        showToast(e.message || 'Load failed', false);
      }
    }

    function renderTable(items){
      if (currentTab === 'users') {
        thead.innerHTML = '<tr><th>Name</th><th>Email</th><th>Role</th><th>Joined</th></tr>';
        tbody.innerHTML = items.map(u=>`<tr><td>${u.name||''}</td><td>${u.email||''}</td><td>${u.role||'consumer'}</td><td>${formatDate(u.createdAt)}</td></tr>`).join('');
      } else if (currentTab === 'providers') {
        thead.innerHTML = '<tr><th>Provider</th><th>Email</th><th>Phone</th><th>City</th><th>Joined</th></tr>';
        tbody.innerHTML = items.map(p=>`<tr><td>${p.providerName||p.actualName||''}</td><td>${p.email||''}</td><td>${p.phone||''}</td><td>${p.address?.city||p.location||''}</td><td>${formatDate(p.createdAt)}</td></tr>`).join('');
      } else if (currentTab === 'agents') {
        thead.innerHTML = '<tr><th>Name</th><th>Email</th><th>Phone</th><th>Vehicle</th><th>City</th><th>Joined</th></tr>';
        tbody.innerHTML = items.map(a=>`<tr><td>${a.name||''}</td><td>${a.email||''}</td><td>${a.phone||''}</td><td>${a.vehicleType||''}</td><td>${a.serviceArea?.city||''}</td><td>${formatDate(a.createdAt)}</td></tr>`).join('');
      } else if (currentTab === 'orders') {
        thead.innerHTML = '<tr><th>ID</th><th>Status</th><th>Amount</th><th>Customer</th><th>Provider</th><th>Created</th></tr>';
        tbody.innerHTML = items.map(o=>`<tr><td>${o._id.slice(-6).toUpperCase()}</td><td><span class="badge">${o.status}</span></td><td>‚Çπ${o.finalAmount||o.totalAmount||0}</td><td>${o.customer?.name||''}</td><td>${o.provider?.providerName||''}</td><td>${formatDate(o.createdAt)}</td></tr>`).join('');
      }
    }

    function formatDate(d){ return d ? new Date(d).toLocaleString() : ''; }

    async function checkApi() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/test`);
        if (!res.ok) throw new Error('API not reachable');
        const js = await res.json();
        showToast(js.message || 'Connected to API');
      } catch (_) {
        showToast('Cannot reach API at ' + API_BASE_URL, false);
      }
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      if (!ensureAdmin()) return;
      await checkApi();
      tabs.forEach(t=>t.addEventListener('click', ()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        currentTab = t.getAttribute('data-tab');
        statusFilter.style.display = currentTab === 'orders' ? '' : 'none';
        fetchData();
      }));
      document.getElementById('refreshBtn').addEventListener('click', fetchData);
      search.addEventListener('input', ()=> { clearTimeout(window.__admT); window.__admT=setTimeout(fetchData, 300); });
      statusFilter.addEventListener('change', fetchData);
      document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.clear(); window.location.href='login.html'; });
      fetchData();
    });
  </script>
</body>
</html>


